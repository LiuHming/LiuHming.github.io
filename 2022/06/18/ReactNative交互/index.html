<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
  <title>
    ReactNative交互 |
    
    HMing
  </title>
  <!-- Icon -->
  
    <link rel="shortcut icon" href="/favicon.ico">
    
  
<link rel="stylesheet" href="/css/style.css">

  
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<script src="/js/pace.min.js"></script>

<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="HMing" type="application/atom+xml">
</head>

<body>
  <main class="content">
    <section class="outer">
  <article id="post-ReactNative交互" class="article article-type-post" itemscope
  itemprop="blogPost" data-scroll-reveal>

  <div class="article-inner">
    
    <header class="article-header">
      

<h1 class="article-title" itemprop="name">
  ReactNative交互
</h1>



    </header>
    

    
    <div class="article-meta">
      <a href="/2022/06/18/ReactNative%E4%BA%A4%E4%BA%92/" class="article-date">
  <time datetime="2022-06-18T14:01:07.000Z" itemprop="datePublished">2022-06-18</time>
</a>
      
<div class="article-category">
  <a class="article-category-link" href="/categories/%E6%8A%80%E6%9C%AF/">技术</a> / <a class="article-category-link" href="/categories/%E6%8A%80%E6%9C%AF/ReactNative/">ReactNative</a>
</div>

    </div>
    

    
    
<div class="tocbot"></div>

    

    <div class="article-entry" itemprop="articleBody">
      
      
      
      <p>React Native与Android原生交互主要涉及三个方面：1.原生调用rn方法；2.rn调用原生方法；3.rn使用原生自定义组件</p>
<h1 id="Android调用RN方法"><a href="#Android调用RN方法" class="headerlink" title="Android调用RN方法"></a>Android调用RN方法</h1><ol>
<li><p>rn注册事件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const &#123;EventEmitterManager&#125; = NativeModules;</span><br><span class="line">const tempEventEmitterManager = new NativeEventEmitter(EventEmitterManager);</span><br><span class="line"></span><br><span class="line">this.remoteNoti = tempEventEmitterManager.addListener(</span><br><span class="line">            &#x27;CustomEvent&#x27;,</span><br><span class="line">            (e)=&gt;this.androidEvent(e));</span><br></pre></td></tr></table></figure></li>
<li><p>android发送事件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义发送事件的函数</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">sendEvent</span><span class="params">(ReactContext reactContext, String eventName, WritableMap params)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  reactContext.getJSModule(DeviceEventManagerModule.RCTDeviceEventEmitter.class).emit(eventName,params);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="RN调用android方法"><a href="#RN调用android方法" class="headerlink" title="RN调用android方法"></a>RN调用android方法</h1><ol>
<li><p>首先要创建自定义模块<br>一般创建继承于<code>ReactContextBaseJavaModule</code>的类来进行模块方法的封装。实现<code>getName</code>，返回的是rn中使用的模块名。具体供rn调用的方法上使用<code>@ReactMethod</code>标注。官方的例子创建一个toast工具类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ToastModule</span> <span class="keyword">extends</span> <span class="title">ReactContextBaseJavaModule</span> </span>&#123;  <span class="keyword">private</span> <span class="keyword">static</span> ReactApplicationContext reactContext;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ToastModule</span><span class="params">(ReactApplicationContext context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(context);</span><br><span class="line">    reactContext = context;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ToastExample&quot;</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@ReactMethod</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">show</span><span class="params">(String message, <span class="keyword">int</span> duration)</span> </span>&#123;</span><br><span class="line">    Toast.makeText(getReactApplicationContext(), message, duration).show();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>内部还提供了一个可选方法<code>getConstants()</code>，可以给JavaScript提供使用的常量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DURATION_SHORT_KEY = <span class="string">&quot;SHORT&quot;</span>;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DURATION_LONG_KEY = <span class="string">&quot;LONG&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">getConstants</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">final</span> Map&lt;String, Object&gt; constants = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">   constants.put(DURATION_SHORT_KEY, Toast.LENGTH_SHORT);</span><br><span class="line">   constants.put(DURATION_LONG_KEY, Toast.LENGTH_LONG);</span><br><span class="line">   <span class="keyword">return</span> constants;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li>
<li><p>注册自定义模块<br>之后我们要创建一个自定义的Package，并要在Package类的<code>createNativeModules</code>方法中添加创建的模块。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomToastPackage</span> <span class="keyword">implements</span> <span class="title">ReactPackage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//这里添加自定义view</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;ViewManager&gt; <span class="title">createViewManagers</span><span class="params">(ReactApplicationContext reactContext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> List&lt;NativeModule&gt; <span class="title">createNativeModules</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">                              ReactApplicationContext reactContext)</span> </span>&#123;</span><br><span class="line">    List&lt;NativeModule&gt; modules = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    modules.add(<span class="keyword">new</span> ToastModule(reactContext));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> modules;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后在ReactNativeHost里getPackages添加我们的customPackage</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyReactApplication</span> <span class="keyword">extends</span> <span class="title">Application</span> <span class="keyword">implements</span> <span class="title">ReactApplication</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line">        SoLoader.init(<span class="keyword">this</span>, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ReactNativeHost mReactNativeHost = <span class="keyword">new</span> ReactNativeHost(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getUseDeveloperSupport</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> BuildConfig.DEBUG;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">protected</span> List&lt;ReactPackage&gt; <span class="title">getPackages</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Arrays.&lt;ReactPackage&gt;asList(<span class="keyword">new</span> CustomToastPackage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ReactNativeHost <span class="title">getReactNativeHost</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> mReactNativeHost;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>在RN中使用<br>实现了上述步骤后就完成了在RN中自定义模块的注册，名为我们之前<code>getName</code>返回的字符串。之前传递的可选常量可以使用<code>ToastExample.SHORT</code>进行使用。我们可以在RN中使用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">import ToastExample from &#x27;../NativeModules/ToastExample&#x27;</span><br><span class="line"></span><br><span class="line">ToastExample.show（&quot;Something&quot;,ToastExample.SHORT`）</span><br></pre></td></tr></table></figure></li>
<li><p>自定义回调参数，并使用Callback返回结果<br>这里先引入一个<code>@ReactMethod</code>方法中，参数类型与他们对应JavaScript类型的映射表</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Boolean -&gt; Bool</span><br><span class="line">Integer -&gt; Number</span><br><span class="line">Double -&gt; Number</span><br><span class="line">Float -&gt; Number</span><br><span class="line">String -&gt; String</span><br><span class="line">Callback -&gt; function</span><br><span class="line">ReadableMap -&gt; Object</span><br><span class="line">ReadableArray -&gt; Array</span><br></pre></td></tr></table></figure>

<p>JS调用时传递的function在执行原生方法时会转变成Callback</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ReactMethod</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendRequest</span><span class="params">(String message, Callback success, Callback failture)</span> </span>&#123;  </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        String parma1 = message;</span><br><span class="line">        String parma2 = <span class="string">&quot;收到回调信息&quot;</span>;            <span class="comment">// 回调成功，返回结果信息</span></span><br><span class="line">        success.invoke(parma1, parma2);</span><br><span class="line">    &#125;<span class="keyword">catch</span> (IllegalViewOperationException e) &#123;            <span class="comment">// 回调失败，返回错误信息</span></span><br><span class="line">        failture.invoke(e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>相应的RN代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CustomModule.sendRequest(</span><br><span class="line">    <span class="string">&quot;这是带Callback回调的函数方法&quot;</span>,</span><br><span class="line">     (parma1, parma2) =&gt; &#123;</span><br><span class="line">        <span class="keyword">var</span> result = parma1 + parma2;</span><br><span class="line">        console.log(result);</span><br><span class="line">    &#125;,</span><br><span class="line">    errMsg =&gt; &#123;</span><br><span class="line">        console.log(errMsg);</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
<li><p>导出带参函数并使用Promises返回结果<br>RN提供一个桥接方法最后一个参数为Promise,可以使用async/await获取执行结果</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UIManagerModule</span> <span class="keyword">extends</span> <span class="title">ReactContextBaseJavaModule</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String E_LAYOUT_ERROR = <span class="string">&quot;E_LAYOUT_ERROR&quot;</span>;</span><br><span class="line">  <span class="meta">@ReactMethod</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">measureLayout</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">int</span> tag,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">int</span> ancestorTag,</span></span></span><br><span class="line"><span class="params"><span class="function">      Promise promise)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      measureLayout(tag, ancestorTag, mMeasureBuffer);</span><br><span class="line"></span><br><span class="line">      WritableMap map = Arguments.createMap();</span><br><span class="line"></span><br><span class="line">      map.putDouble(<span class="string">&quot;relativeX&quot;</span>, PixelUtil.toDIPFromPixel(mMeasureBuffer[<span class="number">0</span>]));</span><br><span class="line">      map.putDouble(<span class="string">&quot;relativeY&quot;</span>, PixelUtil.toDIPFromPixel(mMeasureBuffer[<span class="number">1</span>]));</span><br><span class="line">      map.putDouble(<span class="string">&quot;width&quot;</span>, PixelUtil.toDIPFromPixel(mMeasureBuffer[<span class="number">2</span>]));</span><br><span class="line">      map.putDouble(<span class="string">&quot;height&quot;</span>, PixelUtil.toDIPFromPixel(mMeasureBuffer[<span class="number">3</span>]));</span><br><span class="line"></span><br><span class="line">      promise.resolve(map);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalViewOperationException e) &#123;</span><br><span class="line">      promise.reject(E_LAYOUT_ERROR, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>相应的RN方法为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">async function measureLayout() &#123;</span><br><span class="line">  try &#123;</span><br><span class="line">    const &#123;</span><br><span class="line">      relativeX,</span><br><span class="line">      relativeY,</span><br><span class="line">      width,</span><br><span class="line">      height</span><br><span class="line">    &#125; = await UIManager.measureLayout(100, 100);</span><br><span class="line"></span><br><span class="line">    console.log(</span><br><span class="line">      relativeX + &#x27;:&#x27; + relativeY + &#x27;:&#x27; + width + &#x27;:&#x27; + height</span><br><span class="line">    );</span><br><span class="line">  &#125; catch (e) &#123;</span><br><span class="line">    console.error(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">measureLayout();</span><br><span class="line"></span><br></pre></td></tr></table></figure></li>
</ol>
<h1 id="自定义视图组件"><a href="#自定义视图组件" class="headerlink" title="自定义视图组件"></a>自定义视图组件</h1><p>整体流程与上面的自定义原生模块很相似。</p>
<ol>
<li><p>创建自定义视图组件<br>创建的自定义UI需要被一个ViewManager或SimpleViewManager的派生类创建管理。一个SimpleViewManager的子类包含背景色、透明度、flexbox等公共属性。每一个子类都是一个单例类。他们被NativeViewHierarchyManager所管理，在合适的时候会委托生成UI组件去更新相应的视图属性。ViewManager还会代理原生视图的所有委托，在适当的时候向RN发送对应的事件通知。下面引用官方的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReactImageManager</span> <span class="keyword">extends</span> <span class="title">SimpleViewManager</span>&lt;<span class="title">ReactImageView</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REACT_CLASS = <span class="string">&quot;RCTImageView&quot;</span>;</span><br><span class="line">  ReactApplicationContext mCallerContext;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">ReactImageManager</span><span class="params">(ReactApplicationContext reactContext)</span> </span>&#123;</span><br><span class="line">    mCallerContext = reactContext;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> REACT_CLASS;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>实现方法<code>createViewInstance</code>返回view实例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ReactImageView <span class="title">createViewInstance</span><span class="params">(ThemedReactContext context)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ReactImageView(context, Fresco.newDraweeControllerBuilder(), <span class="keyword">null</span>, mCallerContext);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过<code>@ReactProp</code>或是<code>@ReactPropGroup</code>的注解来导出属性的设置方法。要导出给 JavaScript 使用的属性，需要申明带有<code>@ReactProp</code>（或<code>@ReactPropGroup</code>）注解的设置方法。方法的第一个参数是要修改属性的视图实例，第二个参数是要设置的属性值。方法的返回值类型必须为<code>void</code>，而且访问控制必须被声明为<code>public</code>。JavaScript 所得知的属性类型会由该方法第二个参数的类型来自动决定。支持的类型有：<code>boolean</code>, <code>int</code>, <code>float</code>, <code>double</code>, <code>String</code>, <code>Boolean</code>, <code>Integer</code>, <code>ReadableArray</code>, <code>ReadableMap</code>。<br>除了<code>name</code>，<code>@ReactProp</code>注解还接受这些可选的参数：<code>defaultBoolean</code>, <code>defaultInt</code>, <code>defaultFloat</code>。这些参数必须是对应的基础类型的值（也就是<code>boolean</code>, <code>int</code>, <code>float</code>），这些值会被传递给 setter 方法，以免 JavaScript 端某些情况下在组件中移除了对应的属性。注意这个”默认”值只对基本类型生效，对于其他的类型而言，当对应的属性删除时，<code>null</code>会作为默认值提供给方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ReactProp(name = &quot;src&quot;)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSrc</span><span class="params">(ReactImageView view, <span class="meta">@Nullable</span> ReadableArray sources)</span> </span>&#123;</span><br><span class="line">  view.setSource(sources);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ReactProp(name = &quot;borderRadius&quot;, defaultFloat = 0f)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBorderRadius</span><span class="params">(ReactImageView view, <span class="keyword">float</span> borderRadius)</span> </span>&#123;</span><br><span class="line">  view.setBorderRadius(borderRadius);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ReactProp(name = ViewProps.RESIZE_MODE)</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setResizeMode</span><span class="params">(ReactImageView view, <span class="meta">@Nullable</span> String resizeMode)</span> </span>&#123;</span><br><span class="line">  view.setScaleType(ImageResizeMode.toScaleType(resizeMode));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>事件的处理</p>
<p>现在我们已经知道了怎么导出一个原生视图组件，并且我们可以在 JS 里很方便的控制它了。不过我们怎么才能处理来自用户的事件，譬如缩放操作或者拖动？当一个原生事件发生的时候，它应该也能触发 JavaScript 端视图上的事件，这两个视图会依据<code>getId()</code>而关联在一起。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyCustomView</span> <span class="keyword">extends</span> <span class="title">View</span> </span>&#123;</span><br><span class="line">   ...</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onReceiveNativeEvent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      WritableMap event = Arguments.createMap();</span><br><span class="line">      event.putString(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;MyMessage&quot;</span>);</span><br><span class="line">      ReactContext reactContext = (ReactContext)getContext();</span><br><span class="line">      reactContext.getJSModule(RCTEventEmitter.class).receiveEvent(</span><br><span class="line">          getId(),</span><br><span class="line">          <span class="string">&quot;topChange&quot;</span>,</span><br><span class="line">          event);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>要把事件名<code>topChange</code>映射到 JavaScript 端的<code>onChange</code>回调属性上，需要在你的<code>ViewManager</code>中覆盖<code>getExportedCustomBubblingEventTypeConstants</code>方法，并在其中进行注册：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ReactImageManager</span> <span class="keyword">extends</span> <span class="title">SimpleViewManager</span>&lt;<span class="title">MyCustomView</span>&gt; </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map <span class="title">getExportedCustomBubblingEventTypeConstants</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MapBuilder.builder()</span><br><span class="line">            .put(</span><br><span class="line">                <span class="string">&quot;topChange&quot;</span>,</span><br><span class="line">                MapBuilder.of(</span><br><span class="line">                    <span class="string">&quot;phasedRegistrationNames&quot;</span>,</span><br><span class="line">                    MapBuilder.of(<span class="string">&quot;bubbled&quot;</span>, <span class="string">&quot;onChange&quot;</span>)))</span><br><span class="line">                    .build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>android端<br><code>reactContext.getJSModule(RCTEventEmitter.class).receiveEvent(yourView.getId(), &quot;topChange&quot;, event);</code><br>receiveEvent第一个参数是viewId，第二个参数是eventName，topChange对应JS接收属性为onChange，第三个参数是需要传递的event。</p>
</li>
<li><p>注册UI组件<br>在之前Package类<code>createNativeModules</code>中的<code>createViewManagers</code>添加我们的UIManager</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;ViewManager&gt; <span class="title">createViewManagers</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">                          ReactApplicationContext reactContext)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Arrays.&lt;ViewManager&gt;asList(</span><br><span class="line">    <span class="keyword">new</span> ReactImageManager(reactContext)</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p>RN中的使用<br>直接引用方式为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ImageView.js</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; requireNativeComponent &#125; from <span class="string">&#x27;react-native&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Composes `View`.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * - src: string</span></span><br><span class="line"><span class="comment"> * - borderRadius: number</span></span><br><span class="line"><span class="comment"> * - resizeMode: &#x27;cover&#x27; | &#x27;contain&#x27; | &#x27;stretch&#x27;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">module</span>.<span class="keyword">exports</span> = requireNativeComponent(<span class="string">&#x27;RCTImageView&#x27;</span>);</span><br></pre></td></tr></table></figure>
<p><code>requireNativeComponent</code>目前只接受一个参数，即原生视图的名字。如果你还需要做一些复杂的逻辑譬如事件处理，那么可以把原生组件用一个普通 React 组件封装。如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MyCustomView.js</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyCustomView</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  constructor(props) &#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>._onChange = <span class="keyword">this</span>._onChange.bind(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  _onChange(event: Event) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.props.onChangeMessage) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.props.onChangeMessage(event.nativeEvent.message);</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;RCTMyCustomView</span><br><span class="line">        &#123;...<span class="keyword">this</span>.props&#125;</span><br><span class="line">        onChange=&#123;<span class="keyword">this</span>._onChange&#125;</span><br><span class="line">      /&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> RCTMyCustomView = requireNativeComponent(`RCTMyCustomView`);</span><br></pre></td></tr></table></figure></li>
</ol>

      
    </div>
    <footer class="article-footer">
        
    </footer>

  </div>

  
  
<nav class="article-nav">
  
  <a href="/2022/06/20/Android%E5%86%85%E5%AD%98%E4%BC%98%E5%8C%96/" class="article-nav-link">
    <strong class="article-nav-caption">前一篇</strong>
    <div class="article-nav-title">
      
      Android内存优化
      
    </div>
  </a>
  
  
  <a href="/2022/06/18/ReactNative%E5%85%B3%E9%94%AE%E5%87%BD%E6%95%B0/" class="article-nav-link">
    <strong class="article-nav-caption">后一篇</strong>
    <div class="article-nav-title">ReactNative关键函数</div>
  </a>
  
</nav>

  

  
  
  
  

</article>

</section>
    <footer class="footer">
  <div class="outer">
    <div class="float-right">
      <ul class="list-inline">
  
  <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
  
  <li><i class="fe fe-bookmark"></i> <span id="busuanzi_value_page_pv"></span></li>
  
</ul>
    </div>
    <ul class="list-inline">
      <li>HMing &copy; 2022</li>
      
        <li></li>
      
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>theme  <a target="_blank" rel="noopener" href="https://github.com/zhwangart/hexo-theme-ocean">Ocean</a></li>
    </ul>
  </div>
</footer>
  </main>
  <aside class="sidebar">
    <button class="navbar-toggle"></button>
<nav class="navbar">
  
  <div class="logo">
    <a href="/"><img src="/images/hexo.svg" alt="HMing"></a>
  </div>
  
  <ul class="nav nav-main">
    
    <li class="nav-item">
      <a class="nav-item-link" href="/">主页</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/archives">记录</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/categories">归档</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/gallery">相册</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link" href="/about">关于</a>
    </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="搜索">
        <i class="fe fe-search"></i>
        搜索
      </a>
    </li>
  </ul>
</nav>
<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      <div class="totop" id="totop">
  <i class="fe fe-rocket"></i>
</div>
    </li>
    <li class="nav-item">
      
      <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
        <i class="fe fe-feed"></i>
      </a>
      
    </li>
  </ul>
</nav>
<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
  </aside>
  
<script src="/js/jquery-2.0.3.min.js"></script>


<script src="/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/lazyload.min.js"></script>


<script src="/js/busuanzi-2.3.pure.min.js"></script>



<script src="/fancybox/jquery.fancybox.min.js"></script>





<script src="/js/tocbot.min.js"></script>


<script>
  // Tocbot_v4.7.0  http://tscanlin.github.io/tocbot/
  tocbot.init({
    tocSelector: '.tocbot',
    contentSelector: '.article-entry',
    headingSelector: 'h1, h2, h3, h4, h5, h6',
    hasInnerContainers: true,
    scrollSmooth: true,
    positionFixedSelector: '.tocbot',
    positionFixedClass: 'is-position-fixed',
    fixedSidebarOffset: 'auto',
  });
</script>



<script src="/js/ocean.js"></script>

</body>

</html>